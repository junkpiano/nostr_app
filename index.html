<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mike's Nostr Posts</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900">
    <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-8 text-center shadow">
        <h1 class="text-2xl sm:text-4xl font-bold">Mike's Nostr Posts</h1>
    </header>

    <main class="w-full max-w-3xl mx-auto mt-6 sm:mt-10 px-4 sm:px-6 lg:px-8">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4">Posts:</h2>
            <div id="nostr-output" class="space-y-4 text-sm font-mono overflow-x-auto">
                <p id="connecting-msg">Connecting to relays...</p>
            </div>
            <div class="mt-6 text-center">
                <button id="load-more"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded w-full sm:w-auto">
                    Load More
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { nip19 } from "https://esm.sh/nostr-tools";

        const npub = "npub1ukw4ck0vwlnfv7ntpmchs49kgz37st9pdqfxfqc3q93jkt4xvj4q3w30l2";
        const relays = ["wss://nos.lol", "wss://relay.nostr.band"];
        const output = document.getElementById("nostr-output");
        const loadMoreBtn = document.getElementById("load-more");
        const connectingMsg = document.getElementById("connecting-msg");
        const seenEventIds = new Set();
        let untilTimestamp = Math.floor(Date.now() / 1000);
        const limit = 10;

        const decoded = nip19.decode(npub);
        const pubkeyHex = decoded.data;

        let profile = null;

        function shortenNpub(npub) {
            return npub.slice(0, 12) + "...";
        }

        function getAvatarURL(pubkey) {
            return profile?.picture || `https://robohash.org/${pubkey}.png`;
        }

        function getDisplayName(pubkey, npub) {
            return profile?.nip05 || profile?.name || shortenNpub(npub);
        }

        function fetchProfile() {
            return new Promise((resolve) => {
                const socket = new WebSocket(relays[0]);
                socket.onopen = () => {
                    const subId = "profile-" + Math.random().toString(36).slice(2);
                    const req = ["REQ", subId, { kinds: [0], authors: [pubkeyHex], limit: 1 }];
                    socket.send(JSON.stringify(req));
                };
                socket.onmessage = (msg) => {
                    const arr = JSON.parse(msg.data);
                    if (arr[0] === "EVENT" && arr[2]?.kind === 0) {
                        try {
                            profile = JSON.parse(arr[2].content);
                        } catch (e) {
                            console.warn("Failed to parse profile", e);
                        }
                        socket.close();
                        resolve();
                    }
                };
            });
        }


        function renderEvent(event, npub, pubkey) {
            const avatar = getAvatarURL(pubkey);
            const name = getDisplayName(pubkey, npub);
            const createdAt = new Date(event.created_at * 1000).toLocaleString();

            // Detect URLs in the content and wrap them in <a> tags
            const contentWithLinks = event.content.replace(
                /(https?:\/\/[^\s]+)/g,
                (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">${url}</a>`
            );

            const div = document.createElement("div");
            div.className = "bg-gray-50 border border-gray-200 rounded p-4 shadow";
            div.innerHTML = `
                <div class="flex items-start space-x-4">
                <img src="${avatar}" alt="Avatar" class="w-12 h-12 rounded-full object-cover"
                    onerror="this.src='https://placekitten.com/100/100';" />
                <div class="flex-1 overflow-hidden">
                    <div class="font-semibold text-gray-800 text-sm mb-1">👤 ${name}</div>
                    <div class="whitespace-pre-wrap break-words break-all mb-2 text-sm text-gray-700">${contentWithLinks}</div>
                    <div class="text-xs text-gray-500">🕒 ${createdAt}</div>
                </div>
                </div>
            `;
            output.appendChild(div);
        }


        function loadEvents() {
            for (const relayUrl of relays) {
                const socket = new WebSocket(relayUrl);

                socket.onopen = () => {
                    const subId = 'sub-' + Math.random().toString(36).slice(2);
                    const req = [
                        "REQ", subId,
                        {
                            kinds: [1],
                            authors: [pubkeyHex],
                            until: untilTimestamp,
                            limit: limit
                        }
                    ];
                    socket.send(JSON.stringify(req));
                };

                socket.onmessage = (msg) => {
                    const arr = JSON.parse(msg.data);
                    if (arr[0] === "EVENT") {
                        const event = arr[2];
                        if (seenEventIds.has(event.id)) return;
                        seenEventIds.add(event.id);
                        if (connectingMsg) connectingMsg.remove();

                        const npubStr = nip19.npubEncode(event.pubkey);
                        renderEvent(event, npubStr, event.pubkey);
                        untilTimestamp = Math.min(untilTimestamp, event.created_at);
                    } else if (arr[0] === "EOSE") {
                        socket.close();
                    }
                };

                socket.onerror = (err) => {
                    console.error(`❌ WebSocket error [${relayUrl}]:`, err);
                };
            }
        }

        loadMoreBtn.addEventListener("click", () => loadEvents());

        await fetchProfile();
        loadEvents(); // 初回読み込み
    </script>
</body>

</html>