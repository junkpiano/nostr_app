<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Nostr Widget</title>
</head>

<body>
    <h2>Nostr Post Widget</h2>
    <!-- Add the widget to your page -->
    <nostr-widget npub="npub1ukw4ck0vwlnfv7ntpmchs49kgz37st9pdqfxfqc3q93jkt4xvj4q3w30l2" relay="wss://relay.damus.io"></nostr-widget>

    <!-- Widget Script -->
     <!-- Include nostr-tools library -->
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <script>
        class NostrWidget extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.shadowRoot.innerHTML = `
                    <style>
                        pre {
                            background: #f4f4f4;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-family: monospace;
                            white-space: pre-wrap;
                        }
                        .message {
                            margin-bottom: 10px;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            background: #fff;
                        }
                    </style>
                    <h3>Latest posts:</h3>
                    <pre id="output">Connecting...</pre>
                `;
            }

            connectedCallback() {
                const npub = this.getAttribute('npub');
                const relayUrl = this.getAttribute('relay');
                const output = this.shadowRoot.getElementById('output');

                try {
                    if (!window.NostrTools) {
                        output.textContent = "Failed to load nostr-tools library.";
                        throw new Error("nostrTools is undefined");
                    }

                    const { nip19 } = window.NostrTools;
                    const decoded = nip19.decode(npub);
                    if (decoded.type !== "npub") {
                        throw new Error("Invalid npub format");
                    }

                    const pubkeyHex = decoded.data;
                    const socket = new WebSocket(relayUrl);

                    socket.onopen = () => {
                        const subId = crypto.randomUUID();
                        const now = Math.floor(Date.now() / 1000);

                        const req = [
                            "REQ", subId,
                            {
                                kinds: [1], // text_note
                                authors: [pubkeyHex],
                                limit: 5,
                                until: now
                            }
                        ];

                        socket.send(JSON.stringify(req));
                    };

                    socket.onmessage = (msg) => {
                        const arr = JSON.parse(msg.data);
                        if (arr[0] === "EVENT") {
                            // Clear "Connecting..." text on the first message
                            if (output.textContent === "Connecting...") {
                                output.textContent = "";
                            }

                            const event = arr[2];
                            const content = event.content;
                            const createdAt = new Date(event.created_at * 1000).toLocaleString();

                            const messageElement = document.createElement("div");
                            messageElement.className = "message";
                            messageElement.textContent = `Message:\n\n${content}\n\nCreated at: ${createdAt}`;
                            output.appendChild(messageElement);
                        } else if (arr[0] === "EOSE") {
                            console.log("End of stream");
                        }
                    };

                    socket.onerror = (err) => {
                        output.textContent = "WebSocket error";
                        console.error("WebSocket error:", err);
                    };

                    socket.onclose = () => {
                        console.log("Connection closed");
                    };

                } catch (e) {
                    output.textContent = "Error decoding npub: " + e.message;
                }
            }
        }

        customElements.define('nostr-widget', NostrWidget);
    </script>

    
</body>

</html>