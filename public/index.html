<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nostr Profile Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 text-gray-900">
  <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-8 text-center shadow">
    <h1 class="text-2xl sm:text-4xl font-bold">Nostr Profile Viewer</h1>
  </header>

  <main class="w-full max-w-3xl mx-auto mt-6 sm:mt-10 px-4 sm:px-6 lg:px-8">
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
      <div id="profile-section" class="mb-6 text-center space-y-2">
        <!-- User profile will appear here -->
      </div>

      <h2 id="posts-header" class="text-xl sm:text-2xl font-semibold mb-4">Posts:</h2>
      <div id="nostr-output" class="space-y-4 text-sm font-mono overflow-x-auto">
        <p id="connecting-msg">Connecting to relays...</p>
      </div>

      <div class="mt-6 text-center">
        <button id="load-more"
          class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded w-full sm:w-auto">
          Load More
        </button>
      </div>
    </div>
  </main>

  <script type="module">
    import { nip19 } from "https://esm.sh/nostr-tools";

    const output = document.getElementById("nostr-output");
    const profileSection = document.getElementById("profile-section");
    const loadMoreBtn = document.getElementById("load-more");
    const connectingMsg = document.getElementById("connecting-msg");
    const relays = ["wss://nos.lol", "wss://relay.nostr.band"];
    const limit = 10;
    let seenEventIds = new Set();
    let untilTimestamp = Math.floor(Date.now() / 1000);
    let profile = null;

    // Parse npub from URL
    const path = window.location.pathname;
    const npub = path.replace("/", "").trim();

    if (npub === "") {
      // No address specified â†’ Show input form
      showInputForm();
    } else if (npub.startsWith("npub")) {
      // npub specified â†’ Proceed to load profile
      startApp(npub);
    } else {
      output.innerHTML = "<p class='text-red-500'>Invalid URL format. Please input a valid npub address.</p>";
    }

    function shortenNpub(npub) {
      return npub.slice(0, 12) + "...";
    }

    function getAvatarURL(pubkey) {
      return profile?.picture || `https://robohash.org/${pubkey}.png`;
    }

    function getDisplayName(pubkey, npub) {
      return profile?.nip05 || profile?.name || shortenNpub(npub);
    }

    async function fetchProfile(pubkeyHex) {
      for (const relayUrl of relays) {
        try {
          const socket = new WebSocket(relayUrl);
          await new Promise((resolve, reject) => {
            socket.onopen = () => {
              const subId = "profile-" + Math.random().toString(36).slice(2);
              const req = ["REQ", subId, { kinds: [0], authors: [pubkeyHex], limit: 1 }];
              socket.send(JSON.stringify(req));
            };

            socket.onmessage = (msg) => {
              const arr = JSON.parse(msg.data);
              if (arr[0] === "EVENT" && arr[2]?.kind === 0) {
                try {
                  profile = JSON.parse(arr[2].content);
                } catch (e) {
                  console.warn("Failed to parse profile JSON", e);
                }
                socket.close();
                resolve();
              } else if (arr[0] === "EOSE") {
                socket.close();
                reject(new Error("No profile found"));
              }
            };

            socket.onerror = (err) => {
              console.error(`WebSocket error [${relayUrl}]`, err);
              reject(err);
            };
          });
          break; // If success, stop trying others
        } catch (e) {
          console.warn(`Failed to fetch profile from ${relayUrl}, trying next...`);
        }
      }
    }

    function renderProfile(pubkey, npub) {
      const avatar = getAvatarURL(pubkey);
      const name = getDisplayName(pubkey, npub);
      profileSection.innerHTML = `
        <div class="flex flex-col items-center">
          <img src="${avatar}" alt="Avatar" class="w-20 h-20 rounded-full object-cover mb-2"
            onerror="this.src='https://placekitten.com/100/100';" />
          <h2 class="font-bold text-lg">${name}</h2>
          ${profile?.about ? `<p class="text-gray-600 text-sm mt-1">${profile.about}</p>` : ""}
        </div>
      `;
    }

    function renderEvent(event, npub, pubkey) {
      const avatar = getAvatarURL(pubkey);
      const name = getDisplayName(pubkey, npub);
      const createdAt = new Date(event.created_at * 1000).toLocaleString();

      const contentWithLinks = event.content.replace(
        /(https?:\/\/[^\s]+)/g,
        (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">${url}</a>`
      );

      const div = document.createElement("div");
      div.className = "bg-gray-50 border border-gray-200 rounded p-4 shadow";
      div.innerHTML = `
        <div class="flex items-start space-x-4">
          <img src="${avatar}" alt="Avatar" class="w-12 h-12 rounded-full object-cover"
            onerror="this.src='https://placekitten.com/100/100';" />
          <div class="flex-1 overflow-hidden">
            <div class="font-semibold text-gray-800 text-sm mb-1">ðŸ‘¤ ${name}</div>
            <div class="whitespace-pre-wrap break-words break-all mb-2 text-sm text-gray-700">${contentWithLinks}</div>
            <div class="text-xs text-gray-500">ðŸ•’ ${createdAt}</div>
          </div>
        </div>
      `;
      output.appendChild(div);
    }

    async function loadEvents(pubkeyHex) {
      let anyEventLoaded = false;

      for (const relayUrl of relays) {
        const socket = new WebSocket(relayUrl);

        socket.onopen = () => {
          const subId = 'sub-' + Math.random().toString(36).slice(2);
          const req = [
            "REQ", subId,
            {
              kinds: [1],
              authors: [pubkeyHex],
              until: untilTimestamp,
              limit: limit
            }
          ];
          socket.send(JSON.stringify(req));
        };

        socket.onmessage = (msg) => {
          const arr = JSON.parse(msg.data);
          if (arr[0] === "EVENT") {
            const event = arr[2];
            if (seenEventIds.has(event.id)) return;
            seenEventIds.add(event.id);
            if (connectingMsg) connectingMsg.remove();

            const npubStr = nip19.npubEncode(event.pubkey);
            renderEvent(event, npubStr, event.pubkey);
            untilTimestamp = Math.min(untilTimestamp, event.created_at);
            anyEventLoaded = true;
          } else if (arr[0] === "EOSE") {
            socket.close();
          }
        };

        socket.onerror = (err) => {
          console.error(`WebSocket error [${relayUrl}]`, err);
        };
      }

      setTimeout(() => {
        if (!anyEventLoaded && !output.querySelector("div")) {
          output.innerHTML = "<p class='text-gray-500'>No posts found for this user.</p>";
        }
      }, 3000);
    }

    function showInputForm() {
      document.getElementById("posts-header").style.display = "none";
      // Hide the "Load More" button because no posts yet
      loadMoreBtn.style.display = "none";
      if (connectingMsg) connectingMsg.remove();

      profileSection.innerHTML = `
        <div class="flex flex-col items-center space-y-4">
          <h2 class="text-xl font-semibold">Enter a Nostr npub Address</h2>
          <input id="npub-input" type="text" placeholder="npub1..." 
            class="border border-gray-300 rounded px-4 py-2 w-full max-w-md text-gray-700" />
          <button id="go-button" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded">
            Go
          </button>
        </div>
      `;

      document.getElementById("go-button").addEventListener("click", () => {
        const npub = document.getElementById("npub-input").value.trim();
        if (npub.startsWith("npub")) {
          window.location.href = `/${npub}`;
        } else {
          alert("Please enter a valid npub address!");
        }
      });
    }

    async function startApp(npub) {
      let pubkeyHex;
      try {
        const decoded = nip19.decode(npub);
        pubkeyHex = decoded.data;
      } catch (e) {
        output.innerHTML = "<p class='text-red-500'>Failed to decode npub address.</p>";
        throw e;
      }

      await fetchProfile(pubkeyHex);
      renderProfile(pubkeyHex, npub);
      await loadEvents(pubkeyHex);

      document.getElementById("posts-header").style.display = "";
      loadMoreBtn.addEventListener("click", () => loadEvents(pubkeyHex));
    }
  </script>
</body>

</html>